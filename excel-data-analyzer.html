<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel数据分析器 - 高级筛选工具</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .back-btn {
            position: absolute;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-50%) translateX(-2px);
        }

        .main-content {
            padding: 30px;
        }

        .upload-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .upload-section.dragover {
            border-color: #667eea;
            background: #e8f0fe;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4rem;
            color: #667eea;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #495057;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .filter-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            display: none;
        }
        
        .quick-filters {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .quick-filters h4 {
            margin: 0 0 20px 0;
            color: #495057;
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .quick-filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .quick-filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .quick-filter-group:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        }
        
        .quick-filter-label {
            min-width: 70px;
            font-weight: 500;
            color: #495057;
            font-size: 0.9rem;
        }
        
        .quick-filter-input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 0.9rem;
            width: 100px;
            transition: all 0.3s ease;
        }
        
        .quick-filter-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .quick-filter-unit {
            color: #6c757d;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .quick-filter-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .filter-header h3 {
            color: #495057;
            font-size: 1.5rem;
        }

        .add-filter-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-filter-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .filter-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-select, .filter-input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .filter-select {
            min-width: 150px;
        }

        .filter-input {
            min-width: 120px;
        }

        .remove-filter-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .remove-filter-btn:hover {
            background: #c82333;
        }

        .apply-filters-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .apply-filters-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .results-section {
            display: none;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .results-count {
            color: #495057;
            font-size: 1.1rem;
        }

        .export-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            background: #138496;
            transform: translateY(-1px);
        }

        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            max-height: 600px;
            overflow: auto;
            position: relative;
        }
        
        .table-container thead {
            position: sticky;
            top: 0;
            z-index: 100;
            background: white;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .data-table th {
            background: #f8f9fa;
            color: #495057;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s ease;
        }
        
        .data-table th:hover {
            background: #e9ecef;
        }
        
        .data-table th.sortable {
            position: relative;
        }
        
        .data-table th.sortable::after {
            content: '↕';
            position: absolute;
            right: 8px;
            opacity: 0.5;
            font-size: 0.8rem;
        }
        
        .data-table th.sort-asc::after {
            content: '↑';
            opacity: 1;
            color: #667eea;
        }
        
        .data-table th.sort-desc::after {
            content: '↓';
            opacity: 1;
            color: #667eea;
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #dee2e6;
            min-width: 120px;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .data-table td.image-cell {
            text-align: center;
            padding: 8px;
            width: 150px;
            min-width: 150px;
            max-width: 150px;
        }
        
        .product-image {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #dee2e6;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }
        
        .product-image:hover {
            transform: scale(2.0);
            box-shadow: 0 12px 35px rgba(0,0,0,0.4);
            z-index: 1000;
            border: 2px solid #667eea;
        }
        
        .image-placeholder {
            width: 120px;
            height: 120px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 14px;
            text-align: center;
            line-height: 1.2;
        }
        
        /* 图片放大模态框样式 */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }
        
        .image-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            animation: zoomIn 0.3s ease;
        }
        
        .modal-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 10px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .close-modal {
            position: absolute;
            top: -40px;
            right: 0;
            color: white;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .close-modal:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes zoomIn {
            from { 
                opacity: 0;
                transform: scale(0.5);
            }
            to { 
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .draggable-row {
            cursor: move;
            transition: background-color 0.2s ease;
        }
        
        .draggable-row:hover {
            background-color: #f0f2ff !important;
        }
        
        .draggable-row.dragging {
            opacity: 0.5;
            background-color: #e3f2fd !important;
        }
        
        .drop-indicator {
            height: 2px;
            background-color: #667eea;
            margin: 0;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .drop-indicator.active {
            opacity: 1;
        }
        
        .drag-handle {
            cursor: move;
            color: #6c757d;
            padding: 0 5px;
            font-size: 0.9rem;
        }
        
        .drag-handle:hover {
            color: #667eea;
        }
        
        .data-table td.link-cell {
            color: #1565C0;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .data-table td.link-cell:hover {
            color: #0D47A1;
            background-color: #f0f2ff;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .loading i {
            font-size: 2rem;
            margin-bottom: 10px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .filter-item {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-select, .filter-input {
                min-width: auto;
                width: 100%;
            }
            
            .results-header {
                flex-direction: column;
                gap: 10px;
            }
            
            .quick-filter-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .quick-filter-group {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }
            
            .quick-filter-input {
                width: 100% !important;
            }
            
            .quick-filter-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .apply-filters-btn, .add-filter-btn {
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .quick-filters {
                padding: 15px;
            }
            
            .quick-filter-group {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="ai-tools.html" class="back-btn">
                <i class="fas fa-arrow-left"></i>
                返回AI工具
            </a>
            <h1><i class="fas fa-chart-line"></i> Excel数据分析器</h1>
            <p>上传Excel文件，使用高级筛选功能分析您的商品数据</p>
        </div>

        <div class="main-content">
            <!-- 文件上传区域 -->
            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="upload-text">
                    拖拽Excel文件到此处，或点击按钮选择文件
                </div>
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-file-excel"></i> 选择Excel文件
                </button>
            </div>

            <!-- 筛选条件区域 -->
            <div class="filter-section" id="filterSection">
                <!-- 快速筛选区域 -->
                <div class="quick-filters">
                    <h4><i class="fas fa-tachometer-alt"></i> 快速筛选</h4>
                    
                    <div class="quick-filter-row">
                        <div class="quick-filter-group">
                            <span class="quick-filter-label">商品名称:</span>
                            <input type="text" class="quick-filter-input" id="quickProductName" placeholder="商品名称" style="width: 140px;">
                        </div>
                        
                        <div class="quick-filter-group">
                            <span class="quick-filter-label">SKU:</span>
                            <input type="text" class="quick-filter-input" id="quickSKU" placeholder="sku" style="width: 140px;">
                        </div>
                    </div>
                    
                    <div class="quick-filter-row">
                        <div class="quick-filter-group">
                            <span class="quick-filter-label">销售价格:</span>
                            <input type="number" class="quick-filter-input" id="quickSalePriceMin" placeholder="最小值">
                            <span class="quick-filter-unit">¥ ~</span>
                            <input type="number" class="quick-filter-input" id="quickSalePriceMax" placeholder="最大值">
                            <span class="quick-filter-unit">¥</span>
                        </div>
                        
                        <div class="quick-filter-group">
                            <span class="quick-filter-label">平均价格:</span>
                            <input type="number" class="quick-filter-input" id="quickPriceMin" placeholder="最小值">
                            <span class="quick-filter-unit">¥ ~</span>
                            <input type="number" class="quick-filter-input" id="quickPriceMax" placeholder="最大值">
                            <span class="quick-filter-unit">¥</span>
                        </div>
                    </div>
                    
                    <div class="quick-filter-row">
                        <div class="quick-filter-group">
                            <span class="quick-filter-label">月销量:</span>
                            <input type="number" class="quick-filter-input" id="quickMonthlySalesMin" placeholder="最小值">
                            <span class="quick-filter-unit">~</span>
                            <input type="number" class="quick-filter-input" id="quickMonthlySalesMax" placeholder="最大值">
                        </div>
                        
                        <div class="quick-filter-group">
                            <span class="quick-filter-label">日均销量:</span>
                            <input type="number" class="quick-filter-input" id="quickDailySalesMin" placeholder="最小值">
                            <span class="quick-filter-unit">~</span>
                            <input type="number" class="quick-filter-input" id="quickDailySalesMax" placeholder="最大值">
                        </div>
                    </div>
                    
                    <div class="quick-filter-row">
                        <div class="quick-filter-group">
                            <span class="quick-filter-label">克重:</span>
                            <input type="number" class="quick-filter-input" id="quickWeightMin" placeholder="最小值">
                            <span class="quick-filter-unit">g ~</span>
                            <input type="number" class="quick-filter-input" id="quickWeightMax" placeholder="最大值">
                            <span class="quick-filter-unit">g</span>
                        </div>
                        
                        <div class="quick-filter-group">
                            <span class="quick-filter-label">月销售额:</span>
                            <input type="number" class="quick-filter-input" id="quickRevenueMin" placeholder="最小值">
                            <span class="quick-filter-unit">¥ ~</span>
                            <input type="number" class="quick-filter-input" id="quickRevenueMax" placeholder="最大值">
                            <span class="quick-filter-unit">¥</span>
                        </div>
                    </div>
                    
                    <div class="quick-filter-row">
                        <div class="quick-filter-group">
                            <span class="quick-filter-label">上架时间:</span>
                            <input type="date" class="quick-filter-input" id="quickDateStart" style="width: 120px;">
                            <span class="quick-filter-unit">→</span>
                            <input type="date" class="quick-filter-input" id="quickDateEnd" style="width: 120px;">
                        </div>
                    </div>
                    
                    <div class="quick-filter-actions">
                        <button class="apply-filters-btn" onclick="applyQuickFilters()">
                            <i class="fas fa-search"></i> 应用筛选
                        </button>
                        
                        <button class="add-filter-btn" onclick="clearQuickFilters()" style="background: #6c757d;">
                            <i class="fas fa-eraser"></i> 清空
                        </button>
                    </div>
                </div>
                
                <div class="filter-header">
                    <h3><i class="fas fa-filter"></i> 高级筛选条件</h3>
                    <button class="add-filter-btn" onclick="addFilter()">
                        <i class="fas fa-plus"></i> 添加筛选条件
                    </button>
                </div>
                <div id="filterContainer">
                    <!-- 筛选条件将动态添加到这里 -->
                </div>
                <button class="apply-filters-btn" onclick="applyFilters()">
                    <i class="fas fa-search"></i> 应用筛选
                </button>
            </div>

            <!-- 结果展示区域 -->
            <div class="results-section" id="resultsSection">
                <div class="stats-grid" id="statsGrid">
                    <!-- 统计信息卡片 -->
                </div>
                
                <div class="results-header">
                    <div class="results-count" id="resultsCount">共找到 0 条记录</div>
                    <button class="export-btn" onclick="exportResults()">
                        <i class="fas fa-download"></i> 导出结果
                    </button>
                </div>
                
                <div class="table-container">
                    <table class="data-table" id="dataTable">
                        <thead id="tableHeader"></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let originalData = [];
        let filteredData = [];
        let headers = [];
        let filterCount = 0;
        let currentSort = { column: null, direction: 'asc' };

        // 文件上传处理
        document.getElementById('fileInput').addEventListener('change', handleFile);
        
        // 拖拽上传
        const uploadSection = document.getElementById('uploadSection');
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });
        
        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });
        
        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile({ target: { files: files } });
            }
        });

        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showError('请选择Excel文件（.xlsx或.xls格式）');
                return;
            }

            showLoading('正在读取Excel文件...');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (jsonData.length < 2) {
                        showError('Excel文件数据不足，请确保至少有表头和一行数据');
                        return;
                    }

                    headers = jsonData[0];
                    originalData = jsonData.slice(1).map(row => {
                        const obj = {};
                        headers.forEach((header, index) => {
                            obj[header] = row[index] || '';
                        });
                        return obj;
                    });

                    filteredData = [...originalData];
                    
                    hideLoading();
                    showSuccess(`成功读取 ${originalData.length} 条数据记录`);
                    
                    document.getElementById('filterSection').style.display = 'block';
                    document.getElementById('resultsSection').style.display = 'block';
                    
                    addFilter(); // 添加第一个筛选条件
                    displayResults();
                    
                } catch (error) {
                    hideLoading();
                    showError('读取Excel文件失败：' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function addFilter() {
            filterCount++;
            const filterContainer = document.getElementById('filterContainer');
            
            const filterItem = document.createElement('div');
            filterItem.className = 'filter-item';
            filterItem.id = `filter-${filterCount}`;
            
            filterItem.innerHTML = `
                <select class="filter-select" id="field-${filterCount}">
                    <option value="">选择字段</option>
                    ${headers.map(header => `<option value="${header}">${header}</option>`).join('')}
                </select>
                
                <select class="filter-select" id="operator-${filterCount}">
                    <option value="contains">包含</option>
                    <option value="equals">等于</option>
                    <option value="not_equals">不等于</option>
                    <option value="greater">大于</option>
                    <option value="less">小于</option>
                    <option value="greater_equal">大于等于</option>
                    <option value="less_equal">小于等于</option>
                    <option value="starts_with">开头是</option>
                    <option value="ends_with">结尾是</option>
                    <option value="date_after">日期晚于</option>
                    <option value="date_before">日期早于</option>
                    <option value="date_range">日期范围</option>
                </select>
                
                <input type="text" class="filter-input" id="value-${filterCount}" placeholder="输入筛选值">
                
                <input type="text" class="filter-input" id="value2-${filterCount}" placeholder="结束值（范围筛选）" style="display:none;">
                
                <button class="remove-filter-btn" onclick="removeFilter(${filterCount})">
                    <i class="fas fa-times"></i> 删除
                </button>
            `;
            
            filterContainer.appendChild(filterItem);
            
            // 监听操作符变化，显示/隐藏第二个输入框
            document.getElementById(`operator-${filterCount}`).addEventListener('change', function() {
                const value2Input = document.getElementById(`value2-${filterCount}`);
                if (this.value === 'date_range') {
                    value2Input.style.display = 'inline-block';
                    value2Input.placeholder = '结束日期';
                } else {
                    value2Input.style.display = 'none';
                }
            });
        }

        function removeFilter(id) {
            const filterItem = document.getElementById(`filter-${id}`);
            if (filterItem) {
                filterItem.remove();
            }
        }

        function applyFilters() {
            const filterItems = document.querySelectorAll('.filter-item');
            let filtered = [...originalData];
            
            filterItems.forEach(item => {
                const id = item.id.split('-')[1];
                const field = document.getElementById(`field-${id}`).value;
                const operator = document.getElementById(`operator-${id}`).value;
                const value = document.getElementById(`value-${id}`).value;
                const value2 = document.getElementById(`value2-${id}`).value;
                
                if (field && operator && value) {
                    filtered = filtered.filter(row => {
                        const cellValue = String(row[field] || '').toLowerCase();
                        const filterValue = value.toLowerCase();
                        
                        switch (operator) {
                            case 'contains':
                                return cellValue.includes(filterValue);
                            case 'equals':
                                return cellValue === filterValue;
                            case 'not_equals':
                                return cellValue !== filterValue;
                            case 'greater':
                                return parseFloat(row[field]) > parseFloat(value);
                            case 'less':
                                return parseFloat(row[field]) < parseFloat(value);
                            case 'greater_equal':
                                return parseFloat(row[field]) >= parseFloat(value);
                            case 'less_equal':
                                return parseFloat(row[field]) <= parseFloat(value);
                            case 'starts_with':
                                return cellValue.startsWith(filterValue);
                            case 'ends_with':
                                return cellValue.endsWith(filterValue);
                            case 'date_after':
                                return new Date(row[field]) > new Date(value);
                            case 'date_before':
                                return new Date(row[field]) < new Date(value);
                            case 'date_range':
                                if (value2) {
                                    const date = new Date(row[field]);
                                    return date >= new Date(value) && date <= new Date(value2);
                                }
                                return true;
                            default:
                                return true;
                        }
                    });
                }
            });
            
            filteredData = filtered;
            displayResults();
            showSuccess(`筛选完成，找到 ${filteredData.length} 条符合条件的记录`);
        }

        function displayResults() {
            // 更新统计信息
            updateStats();
            
            // 更新结果计数
            document.getElementById('resultsCount').textContent = `共找到 ${filteredData.length} 条记录`;
            
            // 生成表格
            const tableHeader = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');
            
            // 清空现有内容
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';
            
            if (filteredData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="100%" style="text-align: center; padding: 40px; color: #6c757d;">没有找到符合条件的数据</td></tr>';
                return;
            }
            
            // 定义列的显示顺序
            const columnOrder = [
                '类目链接', '商品名称', '商品名称（中文）', '商品类目', '商品图片', '商品链接',
                '销售价格', '30天内的销量(件)', '包装重量(g)', '品牌', '商品评分', '评价次数',
                '广告费用份额（%）', '商品创建日期','商品体积（升）', '包装长(mm)', '包装宽(mm)', '包装高(mm)',
                '在搜索结果和目录', '预计送达时间', '原价', '商品ID', '配送时间（天）',
                'FBP > 1500卢布佣金（%）', 'FBP <= 1500卢布佣金（%）', 'RFBS > 1500卢布佣金（%）',
                'RFBS <= 1500卢布佣金（%）', '30天内的销售额(卢布)', '销售动态(%)', '平均价格(卢布)',
                '已错过销售(卢布)', '成交率（%）', '商品可用性(%)', '平均日销售额(卢布)',
                '平均日销量(件)', '中的浏览量', '商品卡片浏览量', '从搜索结果和目录中加入购物车(%)',
                '从商品卡片添加至购物车(%)'
            ];
            
            // 重新排列headers，按照指定顺序，未匹配的列放在最后
            const orderedHeaders = [];
            const remainingHeaders = [...headers];
            
            // 按照指定顺序添加存在的列
            columnOrder.forEach(col => {
                const matchedHeader = headers.find(h => 
                    h === col || h.includes(col.replace(/[（）()]/g, '')) || col.includes(h.replace(/[（）()]/g, ''))
                );
                if (matchedHeader && !orderedHeaders.includes(matchedHeader)) {
                    orderedHeaders.push(matchedHeader);
                    const index = remainingHeaders.indexOf(matchedHeader);
                    if (index > -1) remainingHeaders.splice(index, 1);
                }
            });
            
            // 添加剩余的列
            orderedHeaders.push(...remainingHeaders);
            
            // 使用重新排列的headers
            const displayHeaders = orderedHeaders;
            
            // 生成表头
            const headerRow = document.createElement('tr');
            
            // 添加拖拽列
            const dragTh = document.createElement('th');
            dragTh.textContent = '排序';
            dragTh.style.width = '60px';
            dragTh.style.textAlign = 'center';
            headerRow.appendChild(dragTh);
            
            displayHeaders.forEach((header, index) => {
                const th = document.createElement('th');
                th.textContent = header;
                th.className = 'sortable';
                
                // 添加排序状态
                if (currentSort.column === header) {
                    th.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                }
                
                // 添加点击排序事件
                th.onclick = () => sortTable(header);
                
                headerRow.appendChild(th);
            });
            tableHeader.appendChild(headerRow);
            
            // 应用当前排序
            let sortedData = [...filteredData];
            if (currentSort.column) {
                sortedData = sortData(sortedData, currentSort.column, currentSort.direction);
            }
            
            // 生成数据行
            sortedData.forEach((row, rowIndex) => {
                const tr = document.createElement('tr');
                tr.className = 'draggable-row';
                tr.draggable = true;
                tr.dataset.rowIndex = rowIndex;
                
                // 添加拖拽事件
                tr.addEventListener('dragstart', handleDragStart);
                tr.addEventListener('dragover', handleDragOver);
                tr.addEventListener('drop', handleDrop);
                tr.addEventListener('dragend', handleDragEnd);
                
                // 添加拖拽手柄列
                const dragTd = document.createElement('td');
                dragTd.innerHTML = '<span class="drag-handle"><i class="fas fa-grip-vertical"></i></span>';
                dragTd.style.textAlign = 'center';
                tr.appendChild(dragTd);
                
                displayHeaders.forEach(header => {
                    const td = document.createElement('td');
                    const cellValue = row[header] || '';
                    
                    // 检查是否是图片字段
                    if (header.includes('图片') || header.includes('图像') || header.includes('image') || header.includes('Image') ||
                        (typeof cellValue === 'string' && (cellValue.includes('.jpg') || cellValue.includes('.jpeg') || 
                         cellValue.includes('.png') || cellValue.includes('.gif') || cellValue.includes('.webp') ||
                         cellValue.startsWith('http') && (cellValue.includes('image') || cellValue.includes('photo'))))) {
                        td.className = 'image-cell';
                        if (cellValue && (cellValue.startsWith('http') || cellValue.includes('.'))) {
                            const img = document.createElement('img');
                            img.src = cellValue;
                            img.className = 'product-image';
                            img.alt = '商品图片';
                            img.onclick = () => openImageModal(cellValue);
                            img.onerror = function() {
                                this.style.display = 'none';
                                const placeholder = document.createElement('div');
                                placeholder.className = 'image-placeholder';
                                placeholder.textContent = '无图片';
                                td.appendChild(placeholder);
                            };
                            td.appendChild(img);
                        } else {
                            const placeholder = document.createElement('div');
                            placeholder.className = 'image-placeholder';
                            placeholder.textContent = '无图片';
                            td.appendChild(placeholder);
                        }
                    }
                    // 检查是否是链接字段
                    else if (header.includes('链接') || header.includes('URL') || header.includes('url') || 
                        (typeof cellValue === 'string' && cellValue.startsWith('http'))) {
                        td.className = 'link-cell';
                        td.textContent = cellValue;
                        td.onclick = function() {
                            if (cellValue && cellValue.startsWith('http')) {
                                window.open(cellValue, '_blank');
                            }
                        };
                    } else {
                        td.textContent = cellValue;
                    }
                    
                    td.title = cellValue; // 添加tooltip显示完整内容
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }
        
        function sortTable(column) {
            if (currentSort.column === column) {
                // 如果点击的是同一列，切换排序方向
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                // 如果点击的是新列，设置为升序
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            displayResults();
        }
        
        function sortData(data, column, direction) {
            return data.sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';
                
                // 尝试转换为数字
                const aNum = parseFloat(aVal);
                const bNum = parseFloat(bVal);
                
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    // 数字排序
                    return direction === 'asc' ? aNum - bNum : bNum - aNum;
                } else {
                    // 字符串排序
                    aVal = String(aVal).toLowerCase();
                    bVal = String(bVal).toLowerCase();
                    
                    if (direction === 'asc') {
                        return aVal.localeCompare(bVal);
                    } else {
                        return bVal.localeCompare(aVal);
                    }
                }
            });
        }
        
        // 拖拽排序相关变量
        let draggedElement = null;
        let draggedIndex = null;
        
        function handleDragStart(e) {
            draggedElement = this;
            draggedIndex = parseInt(this.dataset.rowIndex);
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            const afterElement = getDragAfterElement(e.clientY);
            const dragging = document.querySelector('.dragging');
            
            if (afterElement == null) {
                document.getElementById('tableBody').appendChild(dragging);
            } else {
                document.getElementById('tableBody').insertBefore(dragging, afterElement);
            }
        }
        
        function handleDrop(e) {
            e.preventDefault();
            
            if (this !== draggedElement) {
                const targetIndex = parseInt(this.dataset.rowIndex);
                
                // 重新排列filteredData数组
                const draggedItem = filteredData[draggedIndex];
                filteredData.splice(draggedIndex, 1);
                
                const newIndex = draggedIndex < targetIndex ? targetIndex - 1 : targetIndex;
                filteredData.splice(newIndex, 0, draggedItem);
                
                // 重新显示结果
                displayResults();
                showSuccess('行排序已更新');
            }
        }
        
        function handleDragEnd(e) {
            this.classList.remove('dragging');
            draggedElement = null;
            draggedIndex = null;
        }
        
        function getDragAfterElement(y) {
            const draggableElements = [...document.querySelectorAll('.draggable-row:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function updateStats() {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = '';
            
            if (filteredData.length === 0) return;
            
            // 基本统计
            const stats = [
                { label: '总记录数', value: filteredData.length },
                { label: '筛选比例', value: `${((filteredData.length / originalData.length) * 100).toFixed(1)}%` }
            ];
            
            // 数值字段统计
            const numericFields = ['销售价格', '原价', '包装重量(g)', '30天内的销售额(卢布)', '30天内的销量(件)'];
            numericFields.forEach(field => {
                if (headers.includes(field)) {
                    const values = filteredData.map(row => parseFloat(row[field])).filter(v => !isNaN(v));
                    if (values.length > 0) {
                        const avg = values.reduce((a, b) => a + b, 0) / values.length;
                        stats.push({
                            label: `${field}平均值`,
                            value: avg.toFixed(2)
                        });
                    }
                }
            });
            
            // 显示统计卡片
            stats.slice(0, 6).forEach(stat => {
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.innerHTML = `
                    <div class="stat-value">${stat.value}</div>
                    <div class="stat-label">${stat.label}</div>
                `;
                statsGrid.appendChild(card);
            });
        }

        function exportResults() {
            if (filteredData.length === 0) {
                showError('没有数据可以导出');
                return;
            }
            
            const ws = XLSX.utils.json_to_sheet(filteredData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '筛选结果');
            
            const fileName = `筛选结果_${new Date().toISOString().slice(0, 10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showSuccess('数据导出成功！');
        }

        function showLoading(message) {
            const uploadSection = document.getElementById('uploadSection');
            uploadSection.innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <div>${message}</div>
                </div>
            `;
        }

        function hideLoading() {
            const uploadSection = document.getElementById('uploadSection');
            uploadSection.innerHTML = `
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="upload-text">
                    拖拽Excel文件到此处，或点击按钮选择文件
                </div>
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-file-excel"></i> 选择Excel文件
                </button>
            `;
            document.getElementById('fileInput').addEventListener('change', handleFile);
        }

        function showError(message) {
            const mainContent = document.querySelector('.main-content');
            const existingError = document.querySelector('.error-message');
            if (existingError) existingError.remove();
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            mainContent.insertBefore(errorDiv, mainContent.firstChild);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const mainContent = document.querySelector('.main-content');
            const existingSuccess = document.querySelector('.success-message');
            if (existingSuccess) existingSuccess.remove();
            
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            mainContent.insertBefore(successDiv, mainContent.firstChild);
            
            setTimeout(() => successDiv.remove(), 3000);
        }
        
        function findMatchingField(row, possibleNames) {
            for (let name of possibleNames) {
                if (row.hasOwnProperty(name)) {
                    return row[name];
                }
            }
            return null;
        }
        
        function applyQuickFilters() {
            let filtered = [...originalData];
            
            // 商品名称筛选
            const productName = document.getElementById('quickProductName').value.trim();
            if (productName) {
                filtered = filtered.filter(row => {
                    const nameFields = ['商品名称', '商品名', '产品名称', '名称', 'name', 'product_name'];
                    const name = findMatchingField(row, nameFields);
                    if (name) {
                        return String(name).toLowerCase().includes(productName.toLowerCase());
                    }
                    return false;
                });
            }
            
            // SKU筛选
            const sku = document.getElementById('quickSKU').value.trim();
            if (sku) {
                filtered = filtered.filter(row => {
                    const skuFields = ['SKU', 'sku', 'Sku', '商品编码', '编码'];
                    const skuValue = findMatchingField(row, skuFields);
                    if (skuValue) {
                        return String(skuValue).toLowerCase().includes(sku.toLowerCase());
                    }
                    return false;
                });
            }
            
            // 销售价格筛选
            const salePriceMin = parseFloat(document.getElementById('quickSalePriceMin').value);
            const salePriceMax = parseFloat(document.getElementById('quickSalePriceMax').value);
            if (!isNaN(salePriceMin) || !isNaN(salePriceMax)) {
                filtered = filtered.filter(row => {
                    const priceFields = ['销售价格', '价格', '单价', '售价', 'price', 'sale_price'];
                    const priceValue = findMatchingField(row, priceFields);
                    const price = parseFloat(priceValue) || 0;
                    
                    if (!isNaN(salePriceMin) && price < salePriceMin) return false;
                    if (!isNaN(salePriceMax) && price > salePriceMax) return false;
                    return true;
                });
            }
            
            // 月销量筛选
            const monthlySalesMin = parseFloat(document.getElementById('quickMonthlySalesMin').value);
            const monthlySalesMax = parseFloat(document.getElementById('quickMonthlySalesMax').value);
            if (!isNaN(monthlySalesMin) || !isNaN(monthlySalesMax)) {
                filtered = filtered.filter(row => {
                    const salesFields = ['月销量', '月销售量', '30天内的销量(件)', '月销量(件)', 'monthly_sales'];
                    const salesValue = findMatchingField(row, salesFields);
                    const sales = parseFloat(salesValue) || 0;
                    
                    if (!isNaN(monthlySalesMin) && sales < monthlySalesMin) return false;
                    if (!isNaN(monthlySalesMax) && sales > monthlySalesMax) return false;
                    return true;
                });
            }
            
            // 日均销量筛选
            const dailySalesMin = parseFloat(document.getElementById('quickDailySalesMin').value);
            const dailySalesMax = parseFloat(document.getElementById('quickDailySalesMax').value);
            if (!isNaN(dailySalesMin) || !isNaN(dailySalesMax)) {
                filtered = filtered.filter(row => {
                    const dailyFields = ['日均销量', '日销量', '平均日销量', 'daily_sales'];
                    const dailyValue = findMatchingField(row, dailyFields);
                    const sales = parseFloat(dailyValue) || 0;
                    
                    if (!isNaN(dailySalesMin) && sales < dailySalesMin) return false;
                    if (!isNaN(dailySalesMax) && sales > dailySalesMax) return false;
                    return true;
                });
            }
            
            // 平均价格筛选
            const priceMin = parseFloat(document.getElementById('quickPriceMin').value);
            const priceMax = parseFloat(document.getElementById('quickPriceMax').value);
            if (!isNaN(priceMin) || !isNaN(priceMax)) {
                filtered = filtered.filter(row => {
                    const priceFields = ['平均价格', '价格', '销售价格', '单价', 'price', 'avg_price'];
                    const priceValue = findMatchingField(row, priceFields);
                    const price = parseFloat(priceValue) || 0;
                    
                    if (!isNaN(priceMin) && price < priceMin) return false;
                    if (!isNaN(priceMax) && price > priceMax) return false;
                    return true;
                });
            }
            
            // 月销售额筛选
            const revenueMin = parseFloat(document.getElementById('quickRevenueMin').value);
            const revenueMax = parseFloat(document.getElementById('quickRevenueMax').value);
            if (!isNaN(revenueMin) || !isNaN(revenueMax)) {
                filtered = filtered.filter(row => {
                    const revenueFields = ['月销售额', '销售额', '30天内的销售额(卢布)', '月收入', 'monthly_revenue'];
                    const revenueValue = findMatchingField(row, revenueFields);
                    const revenue = parseFloat(revenueValue) || 0;
                    
                    if (!isNaN(revenueMin) && revenue < revenueMin) return false;
                    if (!isNaN(revenueMax) && revenue > revenueMax) return false;
                    return true;
                });
            }
            
            // 克重筛选
            const weightMin = parseFloat(document.getElementById('quickWeightMin').value);
            const weightMax = parseFloat(document.getElementById('quickWeightMax').value);
            if (!isNaN(weightMin) || !isNaN(weightMax)) {
                filtered = filtered.filter(row => {
                    const weightFields = ['克重', '重量', '包装重量', '包装重量(g)', '重量(g)', 'weight'];
                    const weightValue = findMatchingField(row, weightFields);
                    const weight = parseFloat(weightValue) || 0;
                    
                    if (!isNaN(weightMin) && weight < weightMin) return false;
                    if (!isNaN(weightMax) && weight > weightMax) return false;
                    return true;
                });
            }
            
            // 上架时间筛选
            const dateStart = document.getElementById('quickDateStart').value;
            const dateEnd = document.getElementById('quickDateEnd').value;
            if (dateStart || dateEnd) {
                filtered = filtered.filter(row => {
                    const dateFields = ['上架时间', '创建时间', '商品创建日期', '发布时间', 'create_date', 'publish_date'];
                    const dateValue = findMatchingField(row, dateFields);
                    
                    if (!dateValue) return false;
                    
                    const itemDate = new Date(dateValue);
                    if (isNaN(itemDate.getTime())) return false;
                    
                    if (dateStart && itemDate < new Date(dateStart)) return false;
                    if (dateEnd && itemDate > new Date(dateEnd)) return false;
                    return true;
                });
            }
            
            filteredData = filtered;
            currentSort = { column: null, direction: 'asc' }; // 重置排序
            displayResults();
            showSuccess(`快速筛选完成，找到 ${filteredData.length} 条符合条件的记录`);
        }
        
        function clearQuickFilters() {
            document.getElementById('quickProductName').value = '';
            document.getElementById('quickSKU').value = '';
            document.getElementById('quickSalePriceMin').value = '';
            document.getElementById('quickSalePriceMax').value = '';
            document.getElementById('quickMonthlySalesMin').value = '';
            document.getElementById('quickMonthlySalesMax').value = '';
            document.getElementById('quickDailySalesMin').value = '';
            document.getElementById('quickDailySalesMax').value = '';
            document.getElementById('quickPriceMin').value = '';
            document.getElementById('quickPriceMax').value = '';
            document.getElementById('quickRevenueMin').value = '';
            document.getElementById('quickRevenueMax').value = '';
            document.getElementById('quickWeightMin').value = '';
            document.getElementById('quickWeightMax').value = '';
            document.getElementById('quickDateStart').value = '';
            document.getElementById('quickDateEnd').value = '';
            
            filteredData = [...originalData];
            currentSort = { column: null, direction: 'asc' }; // 重置排序
            displayResults();
            showSuccess('筛选条件已清空，显示所有数据');
        }
        
        // 图片放大模态框功能
        function openImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            
            modalImage.src = imageSrc;
            modal.classList.add('show');
            
            // 阻止背景滚动
            document.body.style.overflow = 'hidden';
        }
        
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('show');
            
            // 恢复背景滚动
            document.body.style.overflow = 'auto';
        }
        
        // 点击模态框背景关闭
        function handleModalClick(event) {
            if (event.target.id === 'imageModal') {
                closeImageModal();
            }
        }
        
        // ESC键关闭模态框
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeImageModal();
            }
        });
    </script>
    
    <!-- 图片放大模态框 -->
    <div id="imageModal" class="image-modal" onclick="handleModalClick(event)">
        <div class="modal-content">
            <span class="close-modal" onclick="closeImageModal()">&times;</span>
            <img id="modalImage" class="modal-image" src="" alt="商品图片">
        </div>
    </div>
</body>
</html>